var Pnd=function(t){var i={logMode:1,boardSizeX:6,boardSizeY:5,typeNum:8,gravity:[0,1],skyfallBases:[1,1,1,1,1,1,0,0],skyfallWeights:[0,0,0,0,0,0,0,0],canvasId:"pndCanvas",orbSrcPrefix:"img/",orbSrcSuffix:".png",orbNames:["fire","water","wood","light","dark","heart","poison","disturb"],transparentImg:"img/1x1.png",bgSrc:"img/bg.png",canvasWidth:360,canvasHeight:600,boardWidth:360,boardHeight:300,orbWidth:58,orbHeight:58,animation:1,comboInterval:500,se:1,testTimes:5e4};return t.init=function(t){var e,t=t||i,r=new this.View(t),o=new this.Model(t);return t.view=r,t.model=o,e=new this.Presenter(t)},t.initTester=function(t){var e,t=t||i,r=new this.Model(t);return t.model=r,e=new this.Tester(t)},t}(Pnd||{});!function(){var t=360,i=300;cellWidth=60,cellHeight=60,orbWidth=58,orbHeight=58,selectedOffsetX=32,selectedOffsetY=32,orbs=[["fire",1],["water",1],["wood",1],["light",1],["dark",1],["heart",1]],skyfall=1;var e=[[2,5,3,5,5,5],[3,4,3,1,1,2],[2,4,3,0,1,5],[4,4,3,1,1,2],[0,1,1,1,3,5]],r=["fire","water","wood","light","dark","heart"],o=function(t){this.canvas,this.orbs=[],this.init(t),this.bindMouseEvent()};o.prototype.init=function(o){var s=this;$("#browser").html(navigator.userAgent),this.boardCanvas=new fabric.StaticCanvas("board_"+o,{renderOnAddRemove:!1}),this.boardCanvas.setDimensions({width:t,height:i});for(var a=0;a<e.length;a++)for(var h=0;h<e[a].length;h++)!function(t,i){var o=new fabric.Image(document.getElementById(r[e[t][i]]+"Img"),{left:i*cellWidth,top:t*cellHeight,width:orbWidth,height:orbHeight});s.boardCanvas.add(o),s.orbs.push(new n(o,{x:i,y:t,type:e[t][i]}))}(a,h);fabric.Image.fromURL("img/bg.png",function(e){e.set({left:0,top:0,width:t,height:i}),s.boardCanvas.add(e),s.boardCanvas.sendToBack(e)});setTimeout(function(){s.boardCanvas.renderAll()},1e3),this.mouseCanvas=new fabric.StaticCanvas("mouse_"+o,{renderOnAddRemove:!1}),this.mouseCanvas.setDimensions({width:t,height:i})},o.prototype.bindMouseEvent=function(){var t=this;$(this.mouseCanvas.lowerCanvasEl).on("touchstart mousedown",function(i){var e=i.clientX||i.originalEvent.touches[0].pageX-window.scrollX,r=i.clientY||i.originalEvent.touches[0].pageY-window.scrollY,o=Math.floor(e/cellWidth),n=Math.floor(r/cellHeight),s=t.getOrb(o,n);s&&t.startDragging(s,i)}).on("touchend mouseup",function(i){$("#log").html("touchend"),t.stopDragging()}).on("touchmove mousemove",function(i){t.draggingFlag&&t.dragOrb(i)})},o.prototype.startDragging=function(t,i){$("#log").html("startDragging");var e=t.obj;this.draggingFlag=1;var o=r[t.type],n=new fabric.Image(document.getElementById(o+"Img"),{width:orbWidth,height:orbHeight});this.mouseCanvas.add(n),e.opacity=.6,this.boardCanvas.renderAll(),this.originOrb=t,this.movingOrb=n},o.prototype.dragOrb=function(t){var i=t.clientX||t.originalEvent.touches[0].pageX-window.scrollX,e=t.clientY||t.originalEvent.touches[0].pageY-window.scrollY;console.log("moving:"+i+"|"+e),this.movingOrb.left=i-selectedOffsetX,this.movingOrb.top=e-selectedOffsetY,this.checkMouse(i,e),this.mouseCanvas.renderAll()},o.prototype.checkMouse=function(t,i){var e=Math.floor(t/orbWidth),r=Math.floor(i/orbHeight);(e!==this.originOrb.x||r!==this.originOrb.y)&&this.exchangeOrb(this.originOrb,this.getOrb(e,r))},o.prototype.stopDragging=function(t,i){this.draggingFlag&&($("#log").html("stopDragging"),this.originOrb.obj.opacity=1,this.movingOrb.remove(),this.draggingFlag=0,this.boardCanvas.renderAll(),this.mouseCanvas.renderAll())},o.prototype.exchangeOrb=function(t,i){var e=t.obj,r=i.obj,o=e.left,n=e.top,s=t.x,a=t.y;e.left=r.left,e.top=r.top,r.left=o,r.top=n,t.x=i.x,t.y=i.y,i.x=s,i.y=a,this.boardCanvas.renderAll()},o.prototype.getOrb=function(t,i){for(s in this.orbs)if(this.orbs[s].x==t&&this.orbs[s].y==i)return this.orbs[s];return!1},o.prototype.getCoordinate=function(t){var i=t.left/orbWidth,e=t.top/orbHeight;return[i,e]};var n=function(t,i){this.x=i.x,this.y=i.y,this.type=i.type,this.obj=t,this.isSelected};window.PAD=o}();var Pnd=function(t){var i=function(t){this.sizeX=t.boardSizeX,this.sizeY=t.boardSizeY,this.amount=this.sizeX*this.sizeY,this.typeNum=t.typeNum,this.gravity=t.gravity,this.skyfallBases=t.skyfallBases,this.skyfallWeights=t.skyfallWeights,this.dataArr=[],this.skyfallArr=[],this.init(t)};return i.prototype.init=function(i){this.matchModel=new t.MatchModel(i),this._initSkyfallArr(),this.empty()},i.prototype.setSkyfallWeights=function(t){for(var i in t)this.skyfallWeights[i]=t[i];this._initSkyfallArr},i.prototype.empty=function(){for(var t=this.amount,i=0;t>i;i++)this.dataArr[i]=[i,-1,0]},i.prototype.fulfill=function(){var t=this._getEmptyNum();this.getOrbsBySkyfall(t)},i.prototype.getOrbsBySkyfall=function(){{var t=this._getEmptyOrbs();i.getOrbsByRates(t.length,this.skyfallArr)}t.forEach(function(){})},i.prototype.randomize=function(){this.empty();var t=this.getOrbsBySkyfall();return this.data=t,this.data},i.prototype.changeOrbsToMixed=function(){},i.prototype.changeOrb=function(){},i.prototype.powerupOrb=function(){},i.prototype.getOrbsNum=function(){for(var t,i=this.amount,e=[],r=this.typeNum,o=0;r>o;o++)e[o]=0;for(var o=0;i>o;o++)t=this.data[o][1],e[t]=void 0==e[t]?1:e[t]+1;return e},i.prototype.matchBoardByRule=function(){var t=[[0,1,2,3],[12,13,14,15],[25,26,27],[11,17,23,29]];return this._matchAll(t)},i.prototype.matchAndDrop=function(){this.matchModel.match;this._matchAll(),this._dropAll()},i.prototype._matchAll=function(t){t.join(",").split(",");return{matchedOrbs:t}},i.prototype._dropAll=function(){for(var t=this.sizeX,i=this.sizeY,e=this.amount,r=t/2,o=i/2,n=this.gravity[0],s=this.gravity[1],a=[],h=0;e>h;h++)a[h]=h;matchedOrbs=matchedOrbs||[];for(var d=matchedOrbs.join(",").split(","),h=0,l=d.length;l>h;h++)if(""!=d[h]){delete a[d[h]];for(var c=d[h]%t,g=Math.floor(d[h]/t);c*n+r>r*n&&g*s+o>o*s;)c-=n,g-=s,isNaN(a[g*t+c])||(a[g*t+c]+=n+s*t)}for(h in a)a[h]==h&&delete a[h];return{matchedOrbs:matchedOrbs,movedOrbs:a}},i.prototype._initSkyfallArr=function(){this.skyfallArr=i.getSkyfallRates(this.skyfallBases,this.skyfallWeights)},i.prototype._getEmptyOrbs=function(){var t=(this.amount,[]);return this.dataArr.forEach(function(i,e){-1==i[1]&&t.push[e]}),t},i.getSkyfallRates=function(t,i){for(var e=t.length,r=0,o=0,n=0,s=[],a=0;e>a;a++)t[a]=t[a]>0?1:0,r+=t[a],o+=i;for(a=0;e>a;a++)a==e-1?s[a]=1:(n+=(1*t[a]/r+i[a]/100)/(1+o/100),s[a]=n);return s},i.getOrbsByRates=function(t,i){for(var i=i||30,e=[],r=0,o=t.length,n=0;i>n;n++){r=Math.random();for(var s=0;o>s;s++)if(random<t[s]){e.push([0,s,0]);break}}return e},t.Model=i,t}(Pnd||{}),Pnd=function(t){var i=function(t){this.min=t.min||3,this.sizeX=t.boardSizeX||6,this.sizeY=t.boardSizeY||5,this.amount=this.sizeX*this.sizeY};return i.prototype._floodfill=function(t){function i(o){var n,s,a,h,d=t[o][1];r[o]!=e&&(r[o]=e,n=this._getNeighbor("l",o),s=this._getNeighbor("r",o),a=this._getNeighbor("u",o),h=this._getNeighbor("d",o),n>-1&&t[n][1]==d&&i(n),s>-1&&t[s][1]==d&&i(s),a>-1&&t[a][1]==d&&i(a),h>-1&&t[h][1]==d&&i(h))}for(var t=(this.amount,this.sizeX,this.sizeY,t||[]),e=0,r=t.map(function(){return-1}),o=[],n=0,s=t.length;s>n;n++)r[n]<0?(o[e]=[n],i(n),e+=1):o[r[n]].push(n);return o},i.prototype._matchPattern=function(t){var i,e=[];for(var r in t)if(i=t[r],i.length<3)delete i;else{e=[];for(var o in i){var n=i[o],s=i.indexOf(this._getNeighbor("l",n)),a=i.indexOf(this._getNeighbor("r",n)),h=i.indexOf(this._getNeighbor("u",n)),d=i.indexOf(this._getNeighbor("d",n));s>-1&&a>-1&&e.push(i[s],i[o],i[a]),h>-1&&d>-1&&e.push(i[h],i[o],i[d])}t[r]=i.filter(function(t){return e.indexOf(t)>-1})}return t},i.prototype.match=function(t){var i=this._floodfill(t);return this._matchPattern(i)},i.prototype._getNeighbor=function(t,i){var e=this.sizeX,r=this.amount;switch(t){case"l":return i%e==0?-1:i-1;case"r":return i%e==e-1?-1:i+1;case"u":return i-e;case"d":return i+e>=r?-1:i+e}},t.MatchModel=i,t}(Pnd||{}),Pnd=function(t){var i=function(t){this.originStr="",this.length=0,this.ctwFlag=0,this.concatChar="-",this.fromString(t)};return i.isNearby=function(t,i){return Math.abs(t[0]-i[0])>1||Math.abs(t[1]-i[1])>1?!1:!0},i.isNeighbour=function(t,i){return Math.pow(t[0]-i[0],2)+Math.pow(t[1]-i[1],2)-1<.001?!0:!1},i.prototype.fromString=function(t){this.originStr=t,this.parseString(t)},i.prototype.parseString=function(t){var e=t,r=this.concatChar,o=[];o=e.split(r);for(var n=0,s=o.length;s>n;n++)o[n]=o[n].split(","),n>0&&(i.isNearby(o[n-1],o[n])?this.length+=1:this.ctwFlag+=1)},i.prototype.toString=function(){return this.originStr},t.Route=i,t}(Pnd||{}),Pnd=function(t){var i=function(t){this.view=t.view,this.model=t.model};return i.prototype.begin=function(){this.model.matchAndDrop()},t.Presenter=i,t}(Pnd||{}),Pnd=function(t){var i=function(t){this.times=t.testTimes,this.model=t.model};return i.prototype.setTest=function(t){},i.prototype.setExpectations=function(t){},i.prototype.run=function(t){for(var t=(this.model,t||this.times),i=0;t>i;i++)func1.apply(this.model)},t.Tester=i,t}(Pnd||{}),Pnd=function(t){var i=function(t){this.transparentImg=t.transparentImg,this.orbSrcPrefix=t.orbSrcPrefix,this.orbSrcSuffix=t.orbSrcSuffix,this.orbNames=t.orbNames,this.bgSrc=t.bgSrc,this.canvasWidth=t.canvasWidth,this.canvasHeight=t.canvasHeight,this.boardWidth=t.boardWidth,this.boardHeight=t.boardHeight,this.boardSizeX=t.boardSizeX,this.boardSizeY=t.boardSizeY,this.cellWidth=this.boardWidth/this.boardSizeX,this.cellHeight=this.boardHeight/this.boardSizeY,this.orbWidth=t.orbWidth,this.orbHeight=t.orbHeight,this.orbMargin=this.cellWidth-this.orbWidth,this.animFlag=t.animFlag,this.comboInterval=t.comboInterval,this.canvasId=t.canvasId,this.rendering=1,this.canvasObj={},this.boardObj={},this.orbContainers=[],this.orbs=[],this.data=Array(this.boardSizeX*this.boardSizeY),this.init()};return i.prototype.init=function(){this._renderContainer()},i.prototype.autoSetRendering=function(){this.setRendering(1)},i.prototype.setRendering=function(t){this.rendering=t},i.prototype.bindBoardEvent=function(){this.bindMouseEvent()},i.prototype.unbindBoardEvent=function(){},i.prototype._bindMouseEvent=function(){var t=this.canvasObj;t.addEventListener("mousedown",function(t){}),t.addEventListener("mouseup",function(t){})},i.prototype.show=function(t){for(var i=this.orbSrcPrefix,e=this.orbSrcSuffix,r=this.orbNames,t=t||[],o=0,n=t.length;n>o;o++)"object"!=typeof t[o]&&(t[o]={type:t[o],plus:0}),this.data[o]=t[o],this.orbs[o].src=i+r[t[o].type]+e},i.prototype.empty=function(){for(var t=0,i=this.orbs.length;i>t;t++)delete this.data[t],this.orbs[t].src=this.transparentImg},i.prototype.handle=function(t){this.eliminate(t.matchedOrbs,function(){this._moveOrbsTo(t.movedOrbs)})},i.prototype.eliminate=function(t,i){var e=[],r=(this.comboInterval,this),o=arguments.callee,n=[];t.length>0?(e=t[0],n=t.slice(1),this._eliminateSingle(e,function(){o.call(r,n,i)})):i.call(this)},i.prototype._eliminateSingle=function(t,i){var e=this.comboInterval,r=this;if(void 0==t)return void i();for(var o=0;o<t.length;o++)delete this.data[o],this.orbs[t[o]].style.opacity=0;this.animation?setTimeout(function(){i.call(r)},e):i.call(this)},i.prototype.drop=function(){this._moveOrbsTo([0,1,2,3,4,5],[12,13,14,15,16,17])},i.prototype._moveOrbsTo=function(t){var i,e,r=this.cellWidth,o=this.cellHeight;for(var n in t)i=t[n]%this.boardSizeX,e=Math.floor(t[n]/this.boardSizeX),this.data[t[n]]=this.data[n],delete this.data[n],this.orbContainers[n].style.webkitTransform="translate3d("+i*r+"px,"+e*o+"px,0)"},i.prototype._renderContainer=function(){var t=this.rendering;switch(t){case 0:this._renderContainerByDom();break;case 1:this._renderContainerByCss3();break;case 2:this._renderContainerByCanvas()}},i.prototype._renderContainerByCss3=function(){var t=document.getElementById(this.canvasId),i=this.boardSizeX,e=this.boardSizeY,r=this.cellWidth,o=this.cellHeight,n=this.orbWidth,s=this.orbHeight;this.canvasObj=t;var a=document.createElement("div");a.style.cssText="width:"+this.boardWidth+"px; height:"+(this.canvasHeight-this.boardHeight)+"px;background: #eee",t.appendChild(a);var h=document.createElement("div");h.style.cssText="width:"+this.boardWidth+"px; height:"+this.boardHeight+'px; background-image:url("'+this.bgSrc+'"); background-size: cover',t.appendChild(h);for(var d=document.createDocumentFragment(),l=0;e>l;l++)for(var c=0;i>c;c++){var g=document.createElement("div");g.id="orb_"+l+"_"+c,g.style.cssText="position: absolute; -webkit-transition: ease-in 0.25s;width:"+r+"px;height:"+o+"px;-webkit-transform: translate3d("+c*r+"px, "+l*o+"px, 0)",this.orbContainers.push(g);var u=document.createElement("img");u.src=this.transparentImg,u.width=n,u.height=s,u.style.cssText="-webkit-transition:"+this.comboInterval/1e3+"s",this.orbs.push(u),g.appendChild(u),d.appendChild(g)}h.appendChild(d),this.boardObj=h},t.View=i,t}(Pnd||{});